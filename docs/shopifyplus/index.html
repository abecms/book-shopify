<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="search" type="application/opensearchdescription+xml" title="Shopify Book" href="/opensearch.xml"><title data-react-helmet="true">Shopify+ | Shopify Book</title><meta data-react-helmet="true" property="og:url" content="https://shopify.livingcolor.academy/docs/shopifyplus"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Shopify+ | Shopify Book"><meta data-react-helmet="true" name="description" content="Les apps ci-dessous n&#x27;existent que pour shopify+"><meta data-react-helmet="true" property="og:description" content="Les apps ci-dessous n&#x27;existent que pour shopify+"><link data-react-helmet="true" rel="shortcut icon" href="/img/logo-white.png"><link data-react-helmet="true" rel="canonical" href="https://shopify.livingcolor.academy/docs/shopifyplus"><link data-react-helmet="true" rel="alternate" href="https://shopify.livingcolor.academy/docs/shopifyplus" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shopify.livingcolor.academy/docs/shopifyplus" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.99722bb7.css">
<link rel="preload" href="/assets/js/runtime~main.da609062.js" as="script">
<link rel="preload" href="/assets/js/main.89b66c40.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="livingcolor" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="livingcolor" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Shopify Recipes</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="livingcolor" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="livingcolor" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Shopify Recipes</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup">How to create a store</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/useful-apps">Apps</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Configuration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/config/config">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/config/back-office">Ajouter des liens dans l&#x27;admin</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/config/product">Product</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Dynamisation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dynamisation/theme">theme</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dynamisation/product">Product</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dynamisation/search">Search</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dynamisation/cart">Cart</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Shopify+</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/shopifyplus">Shopify+</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dev/app">App development</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dev/dev">dev</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dev/graphql">Update a variant with a metafield</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">Customer</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">Import</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dev/customer-import">Import CSV</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">Modules</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/alertstock">Alertstock</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/chronopost">Chronopost</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/cms">CMS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/fastmag">Fastmag</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/socloz">SoCloz</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/systempay">SystemPay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/modules/target2sell">Target2Sell</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">Import</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">Excelify</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dev/magento">Magento</a></li></ul></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">Shopify+</h1></header><p>Les apps ci-dessous n&#x27;existent que pour shopify+</p><header><h1 class="h1Heading_27L5">Migrer de Magento vers Shopify</h1></header><p><a href="https://apps.shopify.com/transporter" target="_blank" rel="noopener noreferrer">https://apps.shopify.com/transporter</a></p><header><h1 class="h1Heading_27L5">Planifier des changements de contenu du site</h1></header><p><a href="https://apps.shopify.com/launchpad" target="_blank" rel="noopener noreferrer">https://apps.shopify.com/launchpad</a></p><header><h1 class="h1Heading_27L5">Créer un workflow</h1></header><p><a href="https://apps.shopify.com/flow" target="_blank" rel="noopener noreferrer">https://apps.shopify.com/flow</a></p><header><h1 class="h1Heading_27L5">Gift cards</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="appeler-un-web-service-depuis-le-checkout-sur-le-champ-discount"></a>Appeler un web service depuis le checkout sur le champ discount<a class="hash-link" href="#appeler-un-web-service-depuis-le-checkout-sur-le-champ-discount" title="Direct link to heading">#</a></h2><ol><li><p>Créer une app proxy qui pourra exposer une route via shopify :
<a href="https://shopify.dev/tutorials/display-data-on-an-online-store-with-an-application-proxy-app-extension" target="_blank" rel="noopener noreferrer">https://shopify.dev/tutorials/display-data-on-an-online-store-with-an-application-proxy-app-extension</a></p></li><li><p>Avec shopify+, il est possible d&#x27;injecter le js dans le fichier layout checkout.liquid. Sans shopify+, il est possible d&#x27;injecter un js en utilisant l&#x27;astuce des js supplémentaires associés à Google Analytics depuis les préférences de shopify</p></li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;script&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  //const discountButton = document.querySelector(&#x27;[data-trekkie-id=&quot;apply_discount_button&quot;]&#x27;);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  //discountButton.addEventListener(&#x27;click&#x27;, function(){</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  //  alert(&#x27;Discount button was clicked.&#x27;); // Replace this line with your code</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  //});</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  document.addEventListener(&quot;DOMContentLoaded&quot;, function() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    $(&#x27;body&#x27;).on(&#x27;click&#x27;, &#x27;[data-trekkie-id=&quot;apply_discount_button&quot;]&#x27;, function(event) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      event.preventDefault()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      var that = $(this)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      $.get(&#x27;/apps/giftcard/check-code?code=&#x27;+$(&#x27;#checkout_reduction_code&#x27;).val()).then(function(data) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        console.log(&#x27;resultat&#x27;, data)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        that.closest(&#x27;form&#x27;).submit()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      });</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  });</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/script&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Avec cette méthode il est possible d&#x27;appeler un ws avant de soumettre le champ discount à Shopify.</p><header><h1 class="h1Heading_27L5">Créer des règles de promotion avancées</h1></header><p><a href="https://apps.shopify.com/script-editor" target="_blank" rel="noopener noreferrer">https://apps.shopify.com/script-editor</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="règles-de-promotion"></a>Règles de promotion<a class="hash-link" href="#règles-de-promotion" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h3><p>Il faut grouper toutes les règles de promotion que l&#x27;on veut appliquer dans un tableau ex. :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CAMPAIGNS = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # $5 off all items with the &quot;sale&quot; tag</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ItemCampaign.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    AndSelector.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      TagSelector.new(&quot;sale&quot;),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      ExcludeGiftCardSelector.new,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    MoneyDiscount.new(5_00, &quot;5$ off all items on sale&quot;,),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # 10% off all items with a price lower than $100</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ItemCampaign.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    AndSelector.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      ExcludeGiftCardSelector.new,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      PriceSelector.new(:lower_than, Money.new(cents: 100_00)),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    PercentageDiscount.new(10, &quot;10% off all items under 100$&quot;),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Give every 3rd item with the tag &quot;letter&quot; for free</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  BogoCampaign.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    TagSelector.new(&quot;letter&quot;),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    PercentageDiscount.new(100, &quot;Third item is free&quot;),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    LowToHighPartitioner.new(2,1),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Iterate through each of the discount campaigns.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CAMPAIGNS.each do |campaign|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Apply the campaign onto the cart.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  campaign.run(Input.cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Par ailleurs, il est impossible de mettre des dates dans les scripts. Il faut donc utiliser launchpad pour planifier des opérations.</p><blockquote><p>Toujours exclure les cartes cadeaux de vos opérations commerciales : <code>next if line_item.variant.product.gift_card?</code> ou <code>next if product.gift_card?</code></p></blockquote><blockquote><p>Pour mettre en avant dans le panier ces promos panier, on pourra utiliser les variables liquid <code>line_item.original_line_price</code> et <code>line_item.message</code>.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="expédition-gratuite-pour-un-type-dexpédition-spécifique-et-un-montant--xeur"></a>Expédition gratuite pour un type d&#x27;expédition spécifique et un montant &gt; xeur<a class="hash-link" href="#expédition-gratuite-pour-un-type-dexpédition-spécifique-et-un-montant--xeur" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Ce script permet de proposer l&#x27;expédition gratuite pour le code du type d&#x27;expédition &quot;Standard&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># pour un montant total du panier de Plus de 200eur</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># et d&#x27;indiquer &#x27;expédition offerte&#x27; sur le panier</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">montant_minimum = 200</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">min_discount_order_amount = Money.new(cents:100) * montant_minimum</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message = &quot;Expédition offerte&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">total = Input.cart.subtotal_price</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if total &gt; min_discount_order_amount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.shipping_rates.each do |shipping_rate|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    next unless shipping_rate.code == &quot;Standard&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    shipping_rate.apply_discount(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      shipping_rate.price,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      message: message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="expédition-gratuite-pour-un-type-dexpédition-un-type-de-produit-et-un-montant--xeur"></a>Expédition gratuite pour un type d&#x27;expédition, un type de produit et un montant &gt; xeur<a class="hash-link" href="#expédition-gratuite-pour-un-type-dexpédition-un-type-de-produit-et-un-montant--xeur" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Ce script permet de proposer l&#x27;expédition gratuite pour le code du type d&#x27;expédition &quot;Standard&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># pour un montant total du panier de Plus de 200eur</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># et si le type de produit Bermudas est dans le panier</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># et d&#x27;indiquer &#x27;expédition offerte&#x27; sur le panier</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TYPES_PRODUITS = [&quot;Bermudas&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MONTANT_MINIMUM = 200</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">######################</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># DON&#x27;T MODIFY BELOW #</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">######################</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">min_discount_order_amount = Money.new(cents:100) * MONTANT_MINIMUM</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">message = &quot;Expédition offerte&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">applyDiscount = false</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cart = Input.cart</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cart.line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  product = line_item.variant.product</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Check the product type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if TYPES_PRODUITS.collect{|el| el.downcase }.include?(product.product_type.downcase)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    applyDiscount = true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">total = Input.cart.subtotal_price</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if total &gt; min_discount_order_amount and applyDiscount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.shipping_rates.each do |shipping_rate|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    next unless shipping_rate.code == &quot;Standard&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    shipping_rate.apply_discount(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      shipping_rate.price,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      message: message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="empêcher-les-code-promos-saisis-par-les-clients-lors-des-soldes-par-exemple"></a>Empêcher les code promos saisis par les clients (lors des soldes par exemple)<a class="hash-link" href="#empêcher-les-code-promos-saisis-par-les-clients-lors-des-soldes-par-exemple" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">if Input.cart.discount_code</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.cart.discount_code.reject(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    message: &quot;Vous ne pouvez pas utiliser de code promo pendant les soldes&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="expédition-gratuite-pour-les-clients-avec-tag-vip"></a>Expédition gratuite pour les clients avec tag &quot;VIP&quot;<a class="hash-link" href="#expédition-gratuite-pour-les-clients-avec-tag-vip" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Define a list of shipping service names that are eligible for free shipping for VIPs.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ELIGIBLE_SERVICES = [&#x27;Standard Ground Shipping&#x27;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the tag that identifies VIP customers.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">VIP_CUSTOMER_TAG = &#x27;VIP&#x27;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># If the customer is a VIP, give them free shipping on the defined services.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if !Input.cart.customer.nil? and Input.cart.customer.tags.include?(VIP_CUSTOMER_TAG)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.shipping_rates.each do |shipping_rate|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if ELIGIBLE_SERVICES.include?(shipping_rate.name)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      shipping_rate.apply_discount(shipping_rate.price, message: &quot;Free shipping for VIP customers!&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Export the rates.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="expédition-gratuite-sur-les-clients-qui-ont-dépensé--de-xeur-sur-toutes-leurs-commandes"></a>Expédition gratuite sur les clients qui ont dépensé + de xeur sur toutes leurs commandes<a class="hash-link" href="#expédition-gratuite-sur-les-clients-qui-ont-dépensé--de-xeur-sur-toutes-leurs-commandes" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">MINIMUM_SPENT = 50 #dollars purchased in history as a customer</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MESSAGE = &quot;Loyal Customer Promotion&quot; #additional message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">customer = Input.cart.customer</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if customer</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if customer.total_spent &gt; (Money.new(cents:100) * MINIMUM_SPENT)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Input.shipping_rates.each do |shipping_rate|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      if shipping_rate.name.include?(&quot;Insured Shipping and Handling (USPS Priority Express)&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        shipping_rate.change_name(&quot;FREE VIP GROUND SHIPPING (USPS Priority Express)&quot;, { message: &quot;&quot; })</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        shipping_rate.apply_discount(shipping_rate.price, message: MESSAGE)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="appliquer-réduction-sur-la-première-commande-dun-client"></a>Appliquer réduction sur la première commande d&#x27;un client<a class="hash-link" href="#appliquer-réduction-sur-la-première-commande-dun-client" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_AMOUNT = 20</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if Input.cart.line_items.size &gt; 1 &amp;&amp; (Input.cart.customer.nil? || Input.cart.customer.orders_count &lt; 1)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    next if product.gift_card?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item = Input.cart.line_items.sort_by { |line_item| line_item.variant.price }.first</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if line_item.quantity &gt; 1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        line_item = line_item.split(take: 1)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Input.cart.line_items &lt;&lt; line_item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(line_item.line_price * (1.0 - (DISCOUNT_AMOUNT / 100.0)), message: &quot;#{DISCOUNT_AMOUNT}% off for first-time customers!&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="appliquer-un-prix-barré-sur-les-clients-loggés-uniquement"></a>Appliquer un prix barré sur les clients loggés uniquement<a class="hash-link" href="#appliquer-un-prix-barré-sur-les-clients-loggés-uniquement" title="Direct link to heading">#</a></h3><p>Il faut créer un metafield spécifique sur les variants d&#x27;un produit afin de stocker le prix à appliquer puis, sachant que les metafields ne sont pas exposés au script editor, il faut utiliser les product properties :</p><p>Pour créer une propriété de produit, il suffit de mettre un champ caché sur la page détail de produit :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;input type=”hidden” name=”properties[special_price]” /&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Ces propriétés sont soumises au shopping cart et peuvent être récupérées dans le script editore comme ça</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">line_item.properties.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># metatag containing the price to be applied : special_price</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if Input.cart.line_items.size &gt; 1 &amp;&amp; (Input.cart.customer.nil?)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item = Input.cart.line_items.sort_by { |line_item| line_item.variant.price }.first</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if line_item.quantity &gt; 1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item = line_item.split(take: 1)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Input.cart.line_items &lt;&lt; line_item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(line_item.properties[&#x27;special_price&#x27;]), message: &quot;Ventes privées&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="appliquer-pourcentage-de-remise-croissant-en-fonction-du-montant-total-du-panier"></a>Appliquer pourcentage de remise croissant en fonction du montant total du panier<a class="hash-link" href="#appliquer-pourcentage-de-remise-croissant-en-fonction-du-montant-total-du-panier" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Define spending thresholds, from lowest spend to highest cart value.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SPENDING_THRESHOLDS = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    spend: 3000,   # spend amount (in cents)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discount: 10   # percentage discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    spend: 5000,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discount: 15</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    spend: 10000,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discount: 20</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Find any applicable spending threshold.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">eligible_threshold = nil</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SPENDING_THRESHOLDS.each do |threshold|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if Input.cart.subtotal_price_was.cents &gt;= threshold[:spend]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    eligible_threshold = threshold</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Apply threshold.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if !eligible_threshold.nil?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.cart.line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(line_item.line_price * (1.0 - (eligible_threshold[:discount] / 100.0)), message: &quot;#{eligible_threshold[:discount]}% off for purchases over $#{eligible_threshold[:spend] / 100}!&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="appliquer-une-réduction-par-palier"></a>Appliquer une réduction par palier<a class="hash-link" href="#appliquer-une-réduction-par-palier" title="Direct link to heading">#</a></h3><p>Dans l&#x27;exemple : 20% de réduction pour + de 10 000 commandés, 15% de réduction pour + de 1000, 10% pour + de 100 et 5% pour + de 10.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNTS_BY_QUANTITY = {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  10_000 =&gt; 20,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  1_000 =&gt; 15,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  100 =&gt; 10,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  10 =&gt; 5,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Input.cart.line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  next if line_item.variant.product.gift_card?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  quantity, discount = DISCOUNTS_BY_QUANTITY.find do |quantity, _|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.quantity &gt;= quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  next unless discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  message = &quot;#{discount}% off when buying at least #{quantity}.&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.line_price * (Decimal.new(1) - discount.to_d / 100),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    message: message,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="réduction-par-palier-pour-un-type-de-produit"></a>Réduction par palier pour un type de produit<a class="hash-link" href="#réduction-par-palier-pour-un-type-de-produit" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Define a list of price tiers.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PRICE_TIERS = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Pricing tiers for Shoes</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_types: [&#x27;Shoes&#x27;],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    group_by: :product, # :product or :variant</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tiers: [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        quantity: 10,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_percentage: 10,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_message: &#x27;10% off for 10+&#x27;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        quantity: 50,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_percentage: 15,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_message: &#x27;15% off for 50+&#x27;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># In most cases, you don&#x27;t need to edit below this line.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Tiered pricing campaign.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class TieredPricingCampaign</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(partitioner, tiers)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @partitioner = partitioner</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @tiers = tiers.sort_by { |tier| tier[:quantity] }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def run(cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @partitioner.partition(cart).each do |k, items|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      total_quantity = items.map(&amp;:quantity).reduce(0, :+)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      applicable_tier = find_tier_for_quantity(total_quantity)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      unless applicable_tier.nil?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        apply_tier_discount(items, applicable_tier)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  private</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    def find_tier_for_quantity(quantity)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      @tiers.select { |tier| tier[:quantity] &lt;= quantity }.last</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    def apply_tier_discount(items, tier)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discount = get_tier_discount(tier)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      items.each do |item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount.apply(item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    def get_tier_discount(tier)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      PercentageDiscount.new(tier[:discount_percentage], tier[:discount_message])</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Select line items by product type.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class ProductTypeSelector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(product_types)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @product_types = Array(product_types).map(&amp;:upcase)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def match?(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @product_types.include?(line_item.variant.product.product_type.upcase)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def group_key</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @product_types.join(&#x27;,&#x27;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Apply a percentage discount to a line item.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class PercentageDiscount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(percent, message = &#x27;&#x27;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @percent = Decimal.new(percent) / 100.0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @message = message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def apply(item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_discount = item.original_line_price * @percent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    new_line_price = item.original_line_price - line_discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if new_line_price &lt; item.line_price</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      item.change_line_price(new_line_price, message: @message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># A pricing tier partition.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class TierPartitioner</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(selector, group_by)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selector = selector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @group_by = group_by</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def partition(cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Filter items</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    items = cart.line_items.select { |item| @selector.match?(item) }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Group items using the appropriate key.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    items.group_by { |item| group_key(item) }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  private</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    def group_key(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      case @group_by</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        when :product</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          line_item.variant.product.id</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        when :variant</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          line_item.variant.id</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          @selector.group_key</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Instantiate and run Price Tiers.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PRICE_TIERS.each do |pt|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  TieredPricingCampaign.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    TierPartitioner.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      ProductTypeSelector.new(pt[:product_types]),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      pt[:group_by]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pt[:tiers]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ).run(Input.cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Export changes.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pourcentage-de-réduction-sur-le-produit-le-moins-cher-du-panier"></a>Pourcentage de réduction sur le produit le moins cher du panier<a class="hash-link" href="#pourcentage-de-réduction-sur-le-produit-le-moins-cher-du-panier" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_AMOUNT = 15</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (Input.cart.line_items.size &gt; 1)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item = Input.cart.line_items.sort_by { |line_item| line_item.variant.price }.first</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if line_item.quantity &gt; 1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item = line_item.split(take: 1)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Input.cart.line_items &lt;&lt; line_item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(line_item.line_price * (1.0 - (DISCOUNT_AMOUNT / 100.0)), message: &quot;#{DISCOUNT_AMOUNT}% off!&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="réduction-si-le-client-a-accepté-le-marketing-lors-de-sa-commande-précédente"></a>Réduction si le client a accepté le marketing lors de sa commande précédente<a class="hash-link" href="#réduction-si-le-client-a-accepté-le-marketing-lors-de-sa-commande-précédente" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the discount for eligible customers.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_AMOUNT = 10</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Checks to see if this is a customer&#x27;s second order, and that they opted into marketing when they placed their first order.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!Input.cart.customer.nil? &amp;&amp; Input.cart.customer.orders_count == 1 &amp;&amp; Input.cart.customer.accepts_marketing?)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.cart.line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(line_item.line_price * (1.0 - (DISCOUNT_AMOUNT / 100.0)), message: &quot;#{DISCOUNT_AMOUNT}% off for subscribing to our newsletter!&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="acheter-2-produits-lun-des-2-est-offert"></a>Acheter 2 produits, l&#x27;un des 2 est offert<a class="hash-link" href="#acheter-2-produits-lun-des-2-est-offert" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAID_ITEM_COUNT = 2</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNTED_ITEM_COUNT = 1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Returns the integer amount of items that must be discounted next</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># given the amount of items seen</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">def discounted_items_to_find(total_items_seen, discounted_items_seen)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Integer(total_items_seen / (PAID_ITEM_COUNT + DISCOUNTED_ITEM_COUNT) * DISCOUNTED_ITEM_COUNT) - discounted_items_seen</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Partitions the items and returns the items that are to be discounted.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Arguments</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ---------</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># * cart</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#   The cart to which split items will be added (typically Input.cart).</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># * line_items</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#   The selected items that are applicable for the campaign.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">def partition(cart, line_items)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Sort the items by price from high to low</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  sorted_items = line_items.sort_by{|line_item| line_item.variant.price}.reverse</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Create an array of items to return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  discounted_items = []</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Keep counters of items seen and discounted, to avoid having to recalculate on each iteration</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  total_items_seen = 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  discounted_items_seen = 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Loop over all the items and find those to be discounted</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  sorted_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    total_items_seen += line_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # After incrementing total_items_seen, see if any items must be discounted</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    count = discounted_items_to_find(total_items_seen, discounted_items_seen)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # If there are none, skip to the next item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    next if count &lt;= 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if count &gt;= line_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      # If the full item quantity must be discounted, add it to the items to return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      # and increment the count of discounted items</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items.push(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items_seen += line_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      # If only part of the item must be discounted, split the item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_item = line_item.split(take: count)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      # Insert the newly-created item in the cart, right after the original item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      position = cart.line_items.find_index(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      cart.line_items.insert(position + 1, discounted_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      # Add it to the list of items to return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items.push(discounted_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items_seen += discounted_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # Return the items to be discounted</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  discounted_items</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">eligible_items = Input.cart.line_items.select do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  product = line_item.variant.product</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  !product.gift_card? &amp;&amp; product.id == 592406273</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">discounted_line_items = partition(Input.cart, eligible_items)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">discounted_line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(Money.zero, message: &quot;Buy 2 get 1 free&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="acheter-le-produit-a-et-obtenir-x-de-réduction-sur-le-produit-b-si-un-code-coupon-a-été-saisi"></a>Acheter le produit A et obtenir x% de réduction sur le produit B si un code coupon a été saisi<a class="hash-link" href="#acheter-le-produit-a-et-obtenir-x-de-réduction-sur-le-produit-b-si-un-code-coupon-a-été-saisi" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Buy anything from collection A and get anything from collection B with X% discount,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># if discount code XYZ is applied</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Custom Message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CHECKOUT_MESSAGE = &quot;Get a 50% off&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Discount code which should me appled</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_CODE = &quot;GET50OFF&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COLLECTION_A = [&quot;BACKPACKS&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COLLECTION_B = [&quot;SHIRTS&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># DISCOUNT VALUE (WITHOUT &quot;%&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_VALUE = 50</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># === Do not change anything below ===</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cart = Input.cart</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">discounted_items_qty = 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">discount_percent = Decimal.new(DISCOUNT_VALUE) / 100.0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Calculate eligible discounted items (X &lt;= ITEMS FROM A COLLECTION)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cart.line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  product = line_item.variant.product</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if COLLECTION_A.collect{|el| el.downcase }.include?(product.product_type.downcase)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discounted_items_qty += line_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">subtotal = cart.subtotal_price_was</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">is_free_item_applied = false</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if cart.discount_code</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if cart.discount_code.code == DISCOUNT_CODE</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      cart.line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        product = line_item.variant.product</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if COLLECTION_B.collect{|el| el.downcase }.include?(product.product_type.downcase) and</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          discounted_items_qty &gt; 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          if(discounted_items_qty &lt; line_item.quantity)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            free_item = line_item.split(take: discounted_items_qty)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            cart.line_items.push(free_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            free_item = line_item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          new_price = line_item.line_price - (line_item.line_price * discount_percent)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          free_item.change_line_price(new_price, message: CHECKOUT_MESSAGE)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          discounted_items_qty -= free_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="acheter-x-quantité-du-produit-a-obtenir-le-produit-b-pour-y-réduction-en--ou-montant"></a>Acheter X quantité du produit A, obtenir le produit B pour y (réduction en % ou montant)<a class="hash-link" href="#acheter-x-quantité-du-produit-a-obtenir-le-produit-b-pour-y-réduction-en--ou-montant" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Launch campaign if discount code is present</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CODE = &#x27;CADEAU15&#x27;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================ Customizable Settings ================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Tiered Discounts by Spend Threshold</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># If the cart total is greater than (or equal to) an entered</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># threshold, the associated discount is applied to the cart. The</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># discount will be spread, as evenly as possible, across all line</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># items.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># - &#x27;threshold&#x27; is the spend amount needed to qualify</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># - &#x27;discount_amount&#x27; is the dollar discount to apply to the</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cart</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># - &#x27;discount_message&#x27; is the message to show when a discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># is applied</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SPENDING_THRESHOLDS_FILTERED_TAG = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_selector_match_type: :include,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_selector_type: :tag,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_selectors: [&quot;season_H20&quot;],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tiers: [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        threshold: 75,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_type: :dollar,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_amount: 15,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_message: &#x27;Remise CADEAU15&#x27;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BUY_X_GET_Y_FOR_Z = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_selector_match_type: :include,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_selector_type: :tag,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_selectors: [&quot;operation_noel&quot;],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    quantity_to_buy: 1,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    quantity_to_discount: 1,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discount_type: :percent,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discount_amount: 50,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discount_message: &#x27;Un artcle acheté, 50% de remise sur le deuxième!&#x27;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ProductSelector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Finds matching products by the entered criteria.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class ProductSelector2</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(match_type, selector_type, selectors)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @match_type = match_type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @comparator = match_type == :include ? &#x27;any?&#x27; : &#x27;none?&#x27;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selector_type = selector_type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selectors = selectors</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def match?(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if self.respond_to?(@selector_type)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      self.send(@selector_type, line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      raise RuntimeError.new(&#x27;Invalid product selector type&#x27;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def tag(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    product_tags = line_item.variant.product.tags.map { |tag| tag.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selectors = @selectors.map { |selector| selector.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (@selectors &amp; product_tags).send(@comparator)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def type(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selectors = @selectors.map { |selector| selector.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (@match_type == :include) == @selectors.include?(line_item.variant.product.product_type.downcase.strip)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def vendor(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selectors = @selectors.map { |selector| selector.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (@match_type == :include) == @selectors.include?(line_item.variant.product.vendor.downcase.strip)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def product_id(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (@match_type == :include) == @selectors.include?(line_item.variant.product.id)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def variant_id(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (@match_type == :include) == @selectors.include?(line_item.variant.id)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def all(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># DiscountApplicator</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Applies the entered discount to the supplied line item.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class DiscountApplicator2</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(discount_type, discount_amount, discount_message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @discount_type = discount_type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @discount_message = discount_message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @discount_amount = if discount_type == :percent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      1 - (discount_amount * 0.01)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      Money.new(cents: 100) * discount_amount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def apply(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    new_line_price = if @discount_type == :percent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      line_item.line_price * @discount_amount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      [line_item.line_price - (@discount_amount * line_item.quantity), Money.zero].max</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(new_line_price, message: @discount_message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># BuyXGetYForZCampaign</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Buy a certain number of &quot;matching&quot; items, get a certain number</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># of the same matching items with the entered discount applied.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class BuyXGetYForZCampaign</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(campaigns)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @campaigns = campaigns</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def run(cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @campaigns.each do |campaign|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      product_selector = ProductSelector2.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:product_selector_match_type],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:product_selector_type],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:product_selectors],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      eligible_items = cart.line_items.select { |line_item| product_selector.match?(line_item) }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      next if eligible_items.nil?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      eligible_items = eligible_items.sort_by { |line_item| -line_item.variant.price }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      quantity_to_buy = campaign[:quantity_to_buy]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      quantity_to_discount = campaign[:quantity_to_discount]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      bundle_size = quantity_to_buy + quantity_to_discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      number_of_bundles = (eligible_items.map(&amp;:quantity).reduce(0, :+) / bundle_size).floor</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      number_of_discountable_items = number_of_bundles * quantity_to_discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      next unless number_of_discountable_items &gt; 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discount_applicator = DiscountApplicator2.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:discount_type],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:discount_amount],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:discount_message]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      self.loop_items(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_applicator, cart, eligible_items, number_of_discountable_items, quantity_to_buy, quantity_to_discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def loop_items(discount_applicator, cart, line_items, num_to_discount, quantity_to_buy, quantity_to_discount)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    surplus = 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    bundle_size = quantity_to_buy + quantity_to_discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      line_quantity = line_item.quantity + surplus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      if line_quantity &gt; quantity_to_buy</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        bundles_per_line = (line_quantity / bundle_size).floor</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        take_quantity = bundles_per_line * quantity_to_discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        surplus += (line_quantity - (bundle_size * bundles_per_line))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if line_item.quantity &gt; take_quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          discount_item = line_item.split(take: take_quantity)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          discount_applicator.apply(discount_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          position = cart.line_items.find_index(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          cart.line_items.insert(position + 1, discount_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          num_to_discount -= take_quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          discount_applicator.apply(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          num_to_discount -= line_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        surplus += line_quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      break if num_to_discount &lt;= 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================ Script Code (do not edit) ================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># DollarDiscountApplicator</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Applies the entered discount to the supplied line item.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class DollarDiscountApplicator</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(discount_message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @discount_message = discount_message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def apply(line_item, discount_amount)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    new_line_price = line_item.line_price - discount_amount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(new_line_price, message: @discount_message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># TieredDiscountBySpendCampaign</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># If the cart total is greater than (or equal to) an entered</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># threshold, the associated discount is applied to the cart. The</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># discount will be spread, as evenly as possible, across all line</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># items.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class TieredDiscountBySpendAndTagCampaign</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(campaigns)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @campaigns = campaigns</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #@tiers = campaign.tiers.sort_by { |tier| tier[:threshold] }.reverse</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def run(cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @campaigns.each do |campaign|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      product_selector = ProductSelector.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:product_selector_match_type],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:product_selector_type],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        campaign[:product_selectors],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      tiers = campaign[:tiers].sort_by { |tier| tier[:threshold] }.reverse</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      applicable_items = cart.line_items.select { |line_item| product_selector.match?(line_item) }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      next if applicable_items.nil?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      total_applicable_cost = applicable_items.map(&amp;:line_price).reduce(Money.zero, :+)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      applicable_tier = tiers.find { |tier|  total_applicable_cost &gt;= (Money.new(cents: 100) * tier[:threshold]) }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      next if applicable_tier.nil?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      #discount_applicator = DiscountApplicator.new(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      # applicable_tier[:discount_type],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      #  applicable_tier[:discount_amount],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      #  applicable_tier[:discount_message]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      #)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      #applicable_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      #  discount_applicator.apply(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      #end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      return if applicable_tier.nil?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discount_applicator = DollarDiscountApplicator.new(applicable_tier[:discount_message])</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discount_amount = applicable_tier[:discount_amount]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      items = applicable_items.sort_by { |line_item| line_item.variant.price }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      self.loop_items(cart, items, discount_amount, discount_applicator)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def loop_items(cart, line_items, discount_amount, discount_applicator)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    avg_discount = (discount_amount.to_f * (1 / line_items.map(&amp;:quantity).reduce(0, :+))).round(2)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    avg_discount = Money.new(cents: 100) * avg_discount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discount_amount = Money.new(cents: 100) * discount_amount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_items.each_with_index do |line_item, index|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      break if discount_amount &lt;= Money.zero</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      line_discount = avg_discount * line_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      if discount_amount &lt; line_discount || index == (line_items.size - 1)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_update = line_item.line_price &gt; discount_amount ? discount_amount : line_item.line_price</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_update = line_item.line_price &gt; line_discount ? line_discount : line_item.line_price</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discount_amount -= discount_update</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      discount_applicator.apply(line_item, discount_update)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================ Script Code (do not edit) ================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ProductSelector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Finds matching products by the entered criteria.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class ProductSelector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(match_type, selector_type, selectors)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @match_type = match_type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @comparator = match_type == :include ? &#x27;any?&#x27; : &#x27;none?&#x27;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selector_type = selector_type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @selectors = selectors</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def match?(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if @selector_type == :tag</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      product_tags = line_item.variant.product.tags.map { |tag| tag.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      @selectors = @selectors.map { |selector| selector.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      (@selectors &amp; product_tags).send(@comparator)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    elsif @selector_type == :type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      @selectors = @selectors.map { |selector| selector.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      (@match_type == :include) == @selectors.include?(line_item.variant.product.product_type.downcase.strip)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    elsif @selector_type == :vendor</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      @selectors = @selectors.map { |selector| selector.downcase.strip }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      (@match_type == :include) == @selectors.include?(line_item.variant.product.vendor.downcase.strip)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    elsif @selector_type == :product_id</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      (@match_type == :include) == @selectors.include?(line_item.variant.product.id)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    elsif @selector_type == :variant_id</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      (@match_type == :include) == @selectors.include?(line_item.variant.id)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      raise RuntimeError.new(&#x27;Invalid product selector type&#x27;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># DiscountApplicator</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Applies the entered discount to the supplied line item.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class DiscountApplicator</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(discount_type, discount_amount, discount_message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @discount_type = discount_type</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @discount_message = discount_message</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @discount_amount = if discount_type == :percent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      1 - (discount_amount * 0.01)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      Money.new(cents: 100) * discount_amount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def apply(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    new_line_price = if @discount_type == :percent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      line_item.line_price * @discount_amount</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      [line_item.line_price - (@discount_amount * line_item.quantity), Money.zero].max</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(new_line_price, message: @discount_message)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># PlayCampaignIfDiscountCodePresent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ================================================================</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class EnableCampaignIfCodeCampaign</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(code, campaign)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @campaign = campaign</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @code = code</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  def run(cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return unless !cart.discount_code.nil? &amp;&amp; cart.discount_code.code == @code</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    @campaign.run(Input.cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CAMPAIGNS = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  BuyXGetYForZCampaign.new(BUY_X_GET_Y_FOR_Z),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CAMPAIGNS.each do |campaign|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  campaign.run(Input.cart)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="acheter-2-ou--du-produit-a-et-obtenez-x-de-réduction-sur-le-produit-le-moins-cher-du-panier"></a>Acheter 2 ou + du produit A et obtenez x% de réduction sur le produit le moins cher du panier<a class="hash-link" href="#acheter-2-ou--du-produit-a-et-obtenez-x-de-réduction-sur-le-produit-le-moins-cher-du-panier" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_PERCENT=30</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CART_DISCOUNT_MESSAGE=&quot;Buy 2 or more items and get 30% off the least expensive item&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">eligible_items = Input.cart.line_items.select do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  product = line_item.variant.product</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  !product.gift_card?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Sort eligible items by price, least exensive first</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">eligible_items = eligible_items.sort_by{|line_item| line_item.variant.price}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">total_items = 0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">eligible_items.each do |line_item|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  total_items += line_item.quantity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if(total_items &gt;= 2)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # pull the least exensive item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item = eligible_items.first</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # calculate the discount to be applied</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  percent = Decimal.new(DISCOUNT_PERCENT) / 100.0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  # make sure we don&#x27;t discount multiple items hiding in a single line item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if line_item.quantity == 1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_discount = line_item.line_price * percent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    puts &quot;line_discount = #{line_discount}&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Just discount the item directly</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(line_item.line_price - line_discount, message: CART_DISCOUNT_MESSAGE)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  else</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # If only part of the item must be discounted, split the item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discounted_item = line_item.split(take: 1)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Insert the newly-created item in the cart, right after the original item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    position = Input.cart.line_items.find_index(line_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    line_discount = discounted_item.line_price * percent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    puts &quot;line_discount = #{line_discount}&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Input.cart.line_items.insert(position + 1, discounted_item)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Discount the new item</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    discounted_item.change_line_price(discounted_item.line_price - line_discount, message: CART_DISCOUNT_MESSAGE)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/dynamisation/cart"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Cart</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/dev/app"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">App development »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#appeler-un-web-service-depuis-le-checkout-sur-le-champ-discount" class="table-of-contents__link">Appeler un web service depuis le checkout sur le champ discount</a></li><li><a href="#règles-de-promotion" class="table-of-contents__link">Règles de promotion</a><ul><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#expédition-gratuite-pour-un-type-dexpédition-spécifique-et-un-montant--xeur" class="table-of-contents__link">Expédition gratuite pour un type d&#39;expédition spécifique et un montant &gt; xeur</a></li><li><a href="#expédition-gratuite-pour-un-type-dexpédition-un-type-de-produit-et-un-montant--xeur" class="table-of-contents__link">Expédition gratuite pour un type d&#39;expédition, un type de produit et un montant &gt; xeur</a></li><li><a href="#empêcher-les-code-promos-saisis-par-les-clients-lors-des-soldes-par-exemple" class="table-of-contents__link">Empêcher les code promos saisis par les clients (lors des soldes par exemple)</a></li><li><a href="#expédition-gratuite-pour-les-clients-avec-tag-vip" class="table-of-contents__link">Expédition gratuite pour les clients avec tag &quot;VIP&quot;</a></li><li><a href="#expédition-gratuite-sur-les-clients-qui-ont-dépensé--de-xeur-sur-toutes-leurs-commandes" class="table-of-contents__link">Expédition gratuite sur les clients qui ont dépensé + de xeur sur toutes leurs commandes</a></li><li><a href="#appliquer-réduction-sur-la-première-commande-dun-client" class="table-of-contents__link">Appliquer réduction sur la première commande d&#39;un client</a></li><li><a href="#appliquer-un-prix-barré-sur-les-clients-loggés-uniquement" class="table-of-contents__link">Appliquer un prix barré sur les clients loggés uniquement</a></li><li><a href="#appliquer-pourcentage-de-remise-croissant-en-fonction-du-montant-total-du-panier" class="table-of-contents__link">Appliquer pourcentage de remise croissant en fonction du montant total du panier</a></li><li><a href="#appliquer-une-réduction-par-palier" class="table-of-contents__link">Appliquer une réduction par palier</a></li><li><a href="#réduction-par-palier-pour-un-type-de-produit" class="table-of-contents__link">Réduction par palier pour un type de produit</a></li><li><a href="#pourcentage-de-réduction-sur-le-produit-le-moins-cher-du-panier" class="table-of-contents__link">Pourcentage de réduction sur le produit le moins cher du panier</a></li><li><a href="#réduction-si-le-client-a-accepté-le-marketing-lors-de-sa-commande-précédente" class="table-of-contents__link">Réduction si le client a accepté le marketing lors de sa commande précédente</a></li><li><a href="#acheter-2-produits-lun-des-2-est-offert" class="table-of-contents__link">Acheter 2 produits, l&#39;un des 2 est offert</a></li><li><a href="#acheter-le-produit-a-et-obtenir-x-de-réduction-sur-le-produit-b-si-un-code-coupon-a-été-saisi" class="table-of-contents__link">Acheter le produit A et obtenir x% de réduction sur le produit B si un code coupon a été saisi</a></li><li><a href="#acheter-x-quantité-du-produit-a-obtenir-le-produit-b-pour-y-réduction-en--ou-montant" class="table-of-contents__link">Acheter X quantité du produit A, obtenir le produit B pour y (réduction en % ou montant)</a></li><li><a href="#acheter-2-ou--du-produit-a-et-obtenez-x-de-réduction-sur-le-produit-le-moins-cher-du-panier" class="table-of-contents__link">Acheter 2 ou + du produit A et obtenez x% de réduction sur le produit le moins cher du panier</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://abecms.slack.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Website</div><ul class="footer__items"><li class="footer__item"><a href="https://livingcolor.fr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="https://docusaurus.io/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="https://docusaurus.io/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright © 2021 Abe SAS. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.da609062.js"></script>
<script src="/assets/js/main.89b66c40.js"></script>
</body>
</html>