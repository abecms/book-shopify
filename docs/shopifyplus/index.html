<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">


<title data-react-helmet="true">shopifyplus | Shopify Book</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Shopify Book"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="# Shopify+"><meta data-react-helmet="true" property="og:description" content="# Shopify+"><meta data-react-helmet="true" property="og:url" content="https://shopify.livingcolor.academy/docs/shopifyplus">

<link data-react-helmet="true" rel="shortcut icon" href="/img/logo-white.png">


<link rel="stylesheet" href="/styles.b62b95ac.css">


<link rel="preload" href="/styles.bd11cfba.js" as="script">

<link rel="preload" href="/runtime~main.84a8950c.js" as="script">

<link rel="preload" href="/main.c4978552.js" as="script">

<link rel="preload" href="/1.8786922e.js" as="script">

<link rel="preload" href="/2.057fe307.js" as="script">

<link rel="preload" href="/28.3dbf4cd4.js" as="script">

<link rel="preload" href="/20ac7829.abcd58b8.js" as="script">

<link rel="preload" href="/17896441.8afd8470.js" as="script">

<link rel="preload" href="/55684925.5485a85f.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.png" alt="livingcolor"><strong>Shopify Recipes</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/docusaurus">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.png" alt="livingcolor"><strong>Shopify Recipes</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/docusaurus">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="sidebarLogo_3ono"><img src="/img/logo.png" alt="livingcolor"><strong>Shopify Recipes</strong></div><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">introduction</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/setup">setup</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Configuration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/config/config">config</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/config/product">product</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Dynamisation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/dynamisation/theme">theme</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/dynamisation/product">Product</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/dynamisation/search">search</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/dynamisation/cart">Cart</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Shopify+</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/shopifyplus">shopifyplus</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Development</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/dev/app">app</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/dev/dev">dev</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/dev/graphql">graphql</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Customer</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Import</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/dev/customer-import">Import CSV</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Import</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Excelify</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/dev/magento">Magento</a></li></ul></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">shopifyplus</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="shopify"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#shopify" title="Direct link to heading">#</a>Shopify+</h1><p>Les apps ci-dessous n&#x27;existent que pour shopify+</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="migrer-de-magento-vers-shopify"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#migrer-de-magento-vers-shopify" title="Direct link to heading">#</a>Migrer de Magento vers Shopify</h1><p><a href="https://apps.shopify.com/transporter">https://apps.shopify.com/transporter</a></p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="planifier-des-changements-de-contenu-du-site"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#planifier-des-changements-de-contenu-du-site" title="Direct link to heading">#</a>Planifier des changements de contenu du site</h1><p><a href="https://apps.shopify.com/launchpad">https://apps.shopify.com/launchpad</a></p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="créer-un-workflow"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#créer-un-workflow" title="Direct link to heading">#</a>Créer un workflow</h1><p><a href="https://apps.shopify.com/flow">https://apps.shopify.com/flow</a></p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="gift-cards"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#gift-cards" title="Direct link to heading">#</a>Gift cards</h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="appeler-un-web-service-depuis-le-checkout-sur-le-champ-discount"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#appeler-un-web-service-depuis-le-checkout-sur-le-champ-discount" title="Direct link to heading">#</a>Appeler un web service depuis le checkout sur le champ discount</h2><ol><li><p>Créer une app proxy qui pourra exposer une route via shopify :
<a href="https://shopify.dev/tutorials/display-data-on-an-online-store-with-an-application-proxy-app-extension">https://shopify.dev/tutorials/display-data-on-an-online-store-with-an-application-proxy-app-extension</a></p></li><li><p>Avec shopify+, il est possible d&#x27;injecter le js dans le fichier layout checkout.liquid. Sans shopify+, il est possible d&#x27;injecter un js en utilisant l&#x27;astuce des js supplémentaires associés à Google Analytics depuis les préférences de shopify</p></li></ol><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;script&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  //const discountButton = document.querySelector(&#x27;[data-trekkie-id=&quot;apply_discount_button&quot;]&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  //discountButton.addEventListener(&#x27;click&#x27;, function(){</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  //  alert(&#x27;Discount button was clicked.&#x27;); // Replace this line with your code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  //});</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  document.addEventListener(&quot;DOMContentLoaded&quot;, function() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    $(&#x27;body&#x27;).on(&#x27;click&#x27;, &#x27;[data-trekkie-id=&quot;apply_discount_button&quot;]&#x27;, function(event) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      event.preventDefault()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var that = $(this)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      $.get(&#x27;/apps/giftcard/check-code?code=&#x27;+$(&#x27;#checkout_reduction_code&#x27;).val()).then(function(data) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        console.log(&#x27;resultat&#x27;, data)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        that.closest(&#x27;form&#x27;).submit()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/script&gt;</span></div></code></pre></div><p>Avec cette méthode il est possible d&#x27;appeler un ws avant de soumettre le champ discount à Shopify.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="créer-des-règles-de-promotion-avancées"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#créer-des-règles-de-promotion-avancées" title="Direct link to heading">#</a>Créer des règles de promotion avancées</h1><p><a href="https://apps.shopify.com/script-editor">https://apps.shopify.com/script-editor</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="règles-de-promotion"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#règles-de-promotion" title="Direct link to heading">#</a>Règles de promotion</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="introduction"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#introduction" title="Direct link to heading">#</a>Introduction</h3><p>Il faut grouper toutes les règles de promotion que l&#x27;on veut appliquer dans un tableau ex. :</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CAMPAIGNS = [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # $5 off all items with the &quot;sale&quot; tag</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ItemCampaign.new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AndSelector.new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      TagSelector.new(&quot;sale&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ExcludeGiftCardSelector.new,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    MoneyDiscount.new(5_00, &quot;5$ off all items on sale&quot;,),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # 10% off all items with a price lower than $100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ItemCampaign.new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AndSelector.new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ExcludeGiftCardSelector.new,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      PriceSelector.new(:lower_than, Money.new(cents: 100_00)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    PercentageDiscount.new(10, &quot;10% off all items under 100$&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Give every 3rd item with the tag &quot;letter&quot; for free</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  BogoCampaign.new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TagSelector.new(&quot;letter&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    PercentageDiscount.new(100, &quot;Third item is free&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    LowToHighPartitioner.new(2,1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Iterate through each of the discount campaigns.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CAMPAIGNS.each do |campaign|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Apply the campaign onto the cart.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  campaign.run(Input.cart)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></code></pre></div><p>Par ailleurs, il est impossible de mettre des dates dans les scripts. Il faut donc utiliser launchpad pour planifier des opérations.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="expédition-gratuite-pour-un-type-dexpédition-spécifique-et-un-montant--xeur"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#expédition-gratuite-pour-un-type-dexpédition-spécifique-et-un-montant--xeur" title="Direct link to heading">#</a>Expédition gratuite pour un type d&#x27;expédition spécifique et un montant &gt; xeur</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Ce script permet de proposer l&#x27;expédition gratuite pour le code du type d&#x27;expédition &quot;Standard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># pour un montant total du panier de Plus de 200eur</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># et d&#x27;indiquer &#x27;expédition offerte&#x27; sur le panier</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">montant_minimum = 200</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">min_discount_order_amount = Money.new(cents:100) * montant_minimum</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">message = &quot;Expédition offerte&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">total = Input.cart.subtotal_price</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if total &gt; min_discount_order_amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.shipping_rates.each do |shipping_rate|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    next unless shipping_rate.code == &quot;Standard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    shipping_rate.apply_discount(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      shipping_rate.price,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      message: message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="expédition-gratuite-pour-un-type-dexpédition-un-type-de-produit-et-un-montant--xeur"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#expédition-gratuite-pour-un-type-dexpédition-un-type-de-produit-et-un-montant--xeur" title="Direct link to heading">#</a>Expédition gratuite pour un type d&#x27;expédition, un type de produit et un montant &gt; xeur</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Ce script permet de proposer l&#x27;expédition gratuite pour le code du type d&#x27;expédition &quot;Standard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># pour un montant total du panier de Plus de 200eur</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># et si le type de produit Bermudas est dans le panier</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># et d&#x27;indiquer &#x27;expédition offerte&#x27; sur le panier</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">TYPES_PRODUITS = [&quot;Bermudas&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">MONTANT_MINIMUM = 200</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">######################</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># DON&#x27;T MODIFY BELOW #</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">######################</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">min_discount_order_amount = Money.new(cents:100) * MONTANT_MINIMUM</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">message = &quot;Expédition offerte&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">applyDiscount = false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cart = Input.cart</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cart.line_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  product = line_item.variant.product</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Check the product type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if TYPES_PRODUITS.collect{|el| el.downcase }.include?(product.product_type.downcase)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    applyDiscount = true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">total = Input.cart.subtotal_price</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if total &gt; min_discount_order_amount and applyDiscount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.shipping_rates.each do |shipping_rate|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    next unless shipping_rate.code == &quot;Standard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    shipping_rate.apply_discount(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      shipping_rate.price,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      message: message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="empêcher-les-code-promos-saisis-par-les-clients-lors-des-soldes-par-exemple"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#empêcher-les-code-promos-saisis-par-les-clients-lors-des-soldes-par-exemple" title="Direct link to heading">#</a>Empêcher les code promos saisis par les clients (lors des soldes par exemple)</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">if Input.cart.discount_code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.cart.discount_code.reject(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    message: &quot;Vous ne pouvez pas utiliser de code promo pendant les soldes&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="expédition-gratuite-pour-les-clients-avec-tag-vip"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#expédition-gratuite-pour-les-clients-avec-tag-vip" title="Direct link to heading">#</a>Expédition gratuite pour les clients avec tag &quot;VIP&quot;</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define a list of shipping service names that are eligible for free shipping for VIPs.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ELIGIBLE_SERVICES = [&#x27;Standard Ground Shipping&#x27;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the tag that identifies VIP customers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">VIP_CUSTOMER_TAG = &#x27;VIP&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># If the customer is a VIP, give them free shipping on the defined services.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if !Input.cart.customer.nil? and Input.cart.customer.tags.include?(VIP_CUSTOMER_TAG)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.shipping_rates.each do |shipping_rate|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ELIGIBLE_SERVICES.include?(shipping_rate.name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      shipping_rate.apply_discount(shipping_rate.price, message: &quot;Free shipping for VIP customers!&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Export the rates.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="expédition-gratuite-sur-les-clients-qui-ont-dépensé--de-xeur-sur-toutes-leurs-commandes"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#expédition-gratuite-sur-les-clients-qui-ont-dépensé--de-xeur-sur-toutes-leurs-commandes" title="Direct link to heading">#</a>Expédition gratuite sur les clients qui ont dépensé + de xeur sur toutes leurs commandes</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">MINIMUM_SPENT = 50 #dollars purchased in history as a customer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">MESSAGE = &quot;Loyal Customer Promotion&quot; #additional message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">customer = Input.cart.customer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if customer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if customer.total_spent &gt; (Money.new(cents:100) * MINIMUM_SPENT)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Input.shipping_rates.each do |shipping_rate|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if shipping_rate.name.include?(&quot;Insured Shipping and Handling (USPS Priority Express)&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        shipping_rate.change_name(&quot;FREE VIP GROUND SHIPPING (USPS Priority Express)&quot;, { message: &quot;&quot; })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        shipping_rate.apply_discount(shipping_rate.price, message: MESSAGE)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.shipping_rates = Input.shipping_rates</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="appliquer-réduction-sur-la-première-commande-dun-client"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#appliquer-réduction-sur-la-première-commande-dun-client" title="Direct link to heading">#</a>Appliquer réduction sur la première commande d&#x27;un client</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_AMOUNT = 20</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if Input.cart.line_items.size &gt; 1 &amp;&amp; (Input.cart.customer.nil? || Input.cart.customer.orders_count &lt; 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    next if product.gift_card?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item = Input.cart.line_items.sort_by { |line_item| line_item.variant.price }.first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if line_item.quantity &gt; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        line_item = line_item.split(take: 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Input.cart.line_items &lt;&lt; line_item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(line_item.line_price * (1.0 - (DISCOUNT_AMOUNT / 100.0)), message: &quot;#{DISCOUNT_AMOUNT}% off for first-time customers!&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="appliquer-un-prix-barré-sur-les-clients-loggés-uniquement"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#appliquer-un-prix-barré-sur-les-clients-loggés-uniquement" title="Direct link to heading">#</a>Appliquer un prix barré sur les clients loggés uniquement</h3><p>Il faut créer un metafield spécifique sur les variants d&#x27;un produit afin de stocker le prix à appliquer puis, sachant que les metafields ne sont pas exposés au script editor, il faut utiliser les product properties :</p><p>Pour créer une propriété de produit, il suffit de mettre un champ caché sur la page détail de produit :</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;input type=”hidden” name=”properties[special_price]” /&gt;</span></div></code></pre></div><p>Ces propriétés sont soumises au shopping cart et peuvent être récupérées dans le script editore comme ça</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">line_item.properties.</span></div></code></pre></div><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># metatag containing the price to be applied : special_price</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if Input.cart.line_items.size &gt; 1 &amp;&amp; (Input.cart.customer.nil?)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item = Input.cart.line_items.sort_by { |line_item| line_item.variant.price }.first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if line_item.quantity &gt; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item = line_item.split(take: 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Input.cart.line_items &lt;&lt; line_item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(line_item.properties[&#x27;special_price&#x27;]), message: &quot;Ventes privées&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="appliquer-pourcentage-de-remise-croissant-en-fonction-du-montant-total-du-panier"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#appliquer-pourcentage-de-remise-croissant-en-fonction-du-montant-total-du-panier" title="Direct link to heading">#</a>Appliquer pourcentage de remise croissant en fonction du montant total du panier</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define spending thresholds, from lowest spend to highest cart value.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SPENDING_THRESHOLDS = [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spend: 3000,   # spend amount (in cents)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    discount: 10   # percentage discount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spend: 5000,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    discount: 15</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spend: 10000,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    discount: 20</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Find any applicable spending threshold.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">eligible_threshold = nil</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SPENDING_THRESHOLDS.each do |threshold|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if Input.cart.subtotal_price_was.cents &gt;= threshold[:spend]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    eligible_threshold = threshold</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Apply threshold.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if !eligible_threshold.nil?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.cart.line_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(line_item.line_price * (1.0 - (eligible_threshold[:discount] / 100.0)), message: &quot;#{eligible_threshold[:discount]}% off for purchases over $#{eligible_threshold[:spend] / 100}!&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="appliquer-une-réduction-par-palier"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#appliquer-une-réduction-par-palier" title="Direct link to heading">#</a>Appliquer une réduction par palier</h3><p>Dans l&#x27;exemple : 20% de réduction pour + de 10 000 commandés, 15% de réduction pour + de 1000, 10% pour + de 100 et 5% pour + de 10.</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNTS_BY_QUANTITY = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  10_000 =&gt; 20,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  1_000 =&gt; 15,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  100 =&gt; 10,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  10 =&gt; 5,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Input.cart.line_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  next if line_item.variant.product.gift_card?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  quantity, discount = DISCOUNTS_BY_QUANTITY.find do |quantity, _|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.quantity &gt;= quantity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  next unless discount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  message = &quot;#{discount}% off when buying at least #{quantity}.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.line_price * (Decimal.new(1) - discount.to_d / 100),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    message: message,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="réduction-par-palier-pour-un-type-de-produit"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#réduction-par-palier-pour-un-type-de-produit" title="Direct link to heading">#</a>Réduction par palier pour un type de produit</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define a list of price tiers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRICE_TIERS = [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Pricing tiers for Shoes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    product_types: [&#x27;Shoes&#x27;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    group_by: :product, # :product or :variant</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tiers: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        quantity: 10,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_percentage: 10,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_message: &#x27;10% off for 10+&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        quantity: 50,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_percentage: 15,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        discount_message: &#x27;15% off for 50+&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># In most cases, you don&#x27;t need to edit below this line.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Tiered pricing campaign.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class TieredPricingCampaign</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(partitioner, tiers)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @partitioner = partitioner</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @tiers = tiers.sort_by { |tier| tier[:quantity] }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def run(cart)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @partitioner.partition(cart).each do |k, items|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      total_quantity = items.map(&amp;:quantity).reduce(0, :+)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      applicable_tier = find_tier_for_quantity(total_quantity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      unless applicable_tier.nil?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        apply_tier_discount(items, applicable_tier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def find_tier_for_quantity(quantity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      @tiers.select { |tier| tier[:quantity] &lt;= quantity }.last</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def apply_tier_discount(items, tier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      discount = get_tier_discount(tier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      items.each do |item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        discount.apply(item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def get_tier_discount(tier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      PercentageDiscount.new(tier[:discount_percentage], tier[:discount_message])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Select line items by product type.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class ProductTypeSelector</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(product_types)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @product_types = Array(product_types).map(&amp;:upcase)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def match?(line_item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @product_types.include?(line_item.variant.product.product_type.upcase)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def group_key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @product_types.join(&#x27;,&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Apply a percentage discount to a line item.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class PercentageDiscount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(percent, message = &#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @percent = Decimal.new(percent) / 100.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @message = message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def apply(item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_discount = item.original_line_price * @percent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    new_line_price = item.original_line_price - line_discount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if new_line_price &lt; item.line_price</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      item.change_line_price(new_line_price, message: @message)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># A pricing tier partition.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class TierPartitioner</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def initialize(selector, group_by)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @selector = selector</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @group_by = group_by</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def partition(cart)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Filter items</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    items = cart.line_items.select { |item| @selector.match?(item) }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Group items using the appropriate key.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    items.group_by { |item| group_key(item) }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def group_key(line_item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      case @group_by</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        when :product</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          line_item.variant.product.id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        when :variant</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          line_item.variant.id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          @selector.group_key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Instantiate and run Price Tiers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRICE_TIERS.each do |pt|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  TieredPricingCampaign.new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TierPartitioner.new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ProductTypeSelector.new(pt[:product_types]),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      pt[:group_by]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pt[:tiers]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ).run(Input.cart)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">##</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Export changes.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="pourcentage-de-réduction-sur-le-produit-le-moins-cher-du-panier"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pourcentage-de-réduction-sur-le-produit-le-moins-cher-du-panier" title="Direct link to heading">#</a>Pourcentage de réduction sur le produit le moins cher du panier</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_AMOUNT = 15</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (Input.cart.line_items.size &gt; 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item = Input.cart.line_items.sort_by { |line_item| line_item.variant.price }.first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if line_item.quantity &gt; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item = line_item.split(take: 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Input.cart.line_items &lt;&lt; line_item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(line_item.line_price * (1.0 - (DISCOUNT_AMOUNT / 100.0)), message: &quot;#{DISCOUNT_AMOUNT}% off!&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="réduction-si-le-client-a-accepté-le-marketing-lors-de-sa-commande-précédente"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#réduction-si-le-client-a-accepté-le-marketing-lors-de-sa-commande-précédente" title="Direct link to heading">#</a>Réduction si le client a accepté le marketing lors de sa commande précédente</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the discount for eligible customers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_AMOUNT = 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Checks to see if this is a customer&#x27;s second order, and that they opted into marketing when they placed their first order.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (!Input.cart.customer.nil? &amp;&amp; Input.cart.customer.orders_count == 1 &amp;&amp; Input.cart.customer.accepts_marketing?)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Input.cart.line_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    line_item.change_line_price(line_item.line_price * (1.0 - (DISCOUNT_AMOUNT / 100.0)), message: &quot;#{DISCOUNT_AMOUNT}% off for subscribing to our newsletter!&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="acheter-2-produits-lun-des-2-est-offert"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#acheter-2-produits-lun-des-2-est-offert" title="Direct link to heading">#</a>Acheter 2 produits, l&#x27;un des 2 est offert</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">PAID_ITEM_COUNT = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNTED_ITEM_COUNT = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Returns the integer amount of items that must be discounted next</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># given the amount of items seen</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def discounted_items_to_find(total_items_seen, discounted_items_seen)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Integer(total_items_seen / (PAID_ITEM_COUNT + DISCOUNTED_ITEM_COUNT) * DISCOUNTED_ITEM_COUNT) - discounted_items_seen</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Partitions the items and returns the items that are to be discounted.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Arguments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ---------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># * cart</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#   The cart to which split items will be added (typically Input.cart).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># * line_items</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#   The selected items that are applicable for the campaign.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def partition(cart, line_items)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Sort the items by price from high to low</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sorted_items = line_items.sort_by{|line_item| line_item.variant.price}.reverse</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Create an array of items to return</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  discounted_items = []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Keep counters of items seen and discounted, to avoid having to recalculate on each iteration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  total_items_seen = 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  discounted_items_seen = 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Loop over all the items and find those to be discounted</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sorted_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    total_items_seen += line_item.quantity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # After incrementing total_items_seen, see if any items must be discounted</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    count = discounted_items_to_find(total_items_seen, discounted_items_seen)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # If there are none, skip to the next item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    next if count &lt;= 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if count &gt;= line_item.quantity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      # If the full item quantity must be discounted, add it to the items to return</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      # and increment the count of discounted items</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items.push(line_item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items_seen += line_item.quantity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      # If only part of the item must be discounted, split the item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_item = line_item.split(take: count)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      # Insert the newly-created item in the cart, right after the original item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      position = cart.line_items.find_index(line_item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      cart.line_items.insert(position + 1, discounted_item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      # Add it to the list of items to return</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items.push(discounted_item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      discounted_items_seen += discounted_item.quantity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  # Return the items to be discounted</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  discounted_items</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">eligible_items = Input.cart.line_items.select do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  product = line_item.variant.product</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  !product.gift_card? &amp;&amp; product.id == 592406273</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">discounted_line_items = partition(Input.cart, eligible_items)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">discounted_line_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  line_item.change_line_price(Money.zero, message: &quot;Buy 2 get 1 free&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="acheter-le-produit-a-et-obtenir-x-de-réduction-sur-le-produit-b-si-un-code-coupon-a-été-saisi"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#acheter-le-produit-a-et-obtenir-x-de-réduction-sur-le-produit-b-si-un-code-coupon-a-été-saisi" title="Direct link to heading">#</a>Acheter le produit A et obtenir x% de réduction sur le produit B si un code coupon a été saisi</h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Buy anything from collection A and get anything from collection B with X% discount,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># if discount code XYZ is applied</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Custom Message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CHECKOUT_MESSAGE = &quot;Get a 50% off&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Discount code which should me appled</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_CODE = &quot;GET50OFF&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COLLECTION_A = [&quot;BACKPACKS&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COLLECTION_B = [&quot;SHIRTS&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># DISCOUNT VALUE (WITHOUT &quot;%&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DISCOUNT_VALUE = 50</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># === Do not change anything below ===</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cart = Input.cart</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">discounted_items_qty = 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">discount_percent = Decimal.new(DISCOUNT_VALUE) / 100.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Calculate eligible discounted items (X &lt;= ITEMS FROM A COLLECTION)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cart.line_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  product = line_item.variant.product</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if COLLECTION_A.collect{|el| el.downcase }.include?(product.product_type.downcase)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    discounted_items_qty += line_item.quantity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">subtotal = cart.subtotal_price_was</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">is_free_item_applied = false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if cart.discount_code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if cart.discount_code.code == DISCOUNT_CODE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      cart.line_items.each do |line_item|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        product = line_item.variant.product</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if COLLECTION_B.collect{|el| el.downcase }.include?(product.product_type.downcase) and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          discounted_items_qty &gt; 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          if(discounted_items_qty &lt; line_item.quantity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            free_item = line_item.split(take: discounted_items_qty)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            cart.line_items.push(free_item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            free_item = line_item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          new_price = line_item.line_price - (line_item.line_price * discount_percent)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          free_item.change_line_price(new_price, message: CHECKOUT_MESSAGE)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          discounted_items_qty -= free_item.quantity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Output.cart = Input.cart</span></div></code></pre></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/dynamisation/cart"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« cart</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/dev/app"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">app »</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#appeler-un-web-service-depuis-le-checkout-sur-le-champ-discount" class="contents__link">Appeler un web service depuis le checkout sur le champ discount</a></li><li><a href="#règles-de-promotion" class="contents__link">Règles de promotion</a><ul><li><a href="#introduction" class="contents__link">Introduction</a></li><li><a href="#expédition-gratuite-pour-un-type-dexpédition-spécifique-et-un-montant--xeur" class="contents__link">Expédition gratuite pour un type d&#39;expédition spécifique et un montant &gt; xeur</a></li><li><a href="#expédition-gratuite-pour-un-type-dexpédition-un-type-de-produit-et-un-montant--xeur" class="contents__link">Expédition gratuite pour un type d&#39;expédition, un type de produit et un montant &gt; xeur</a></li><li><a href="#empêcher-les-code-promos-saisis-par-les-clients-lors-des-soldes-par-exemple" class="contents__link">Empêcher les code promos saisis par les clients (lors des soldes par exemple)</a></li><li><a href="#expédition-gratuite-pour-les-clients-avec-tag-vip" class="contents__link">Expédition gratuite pour les clients avec tag &quot;VIP&quot;</a></li><li><a href="#expédition-gratuite-sur-les-clients-qui-ont-dépensé--de-xeur-sur-toutes-leurs-commandes" class="contents__link">Expédition gratuite sur les clients qui ont dépensé + de xeur sur toutes leurs commandes</a></li><li><a href="#appliquer-réduction-sur-la-première-commande-dun-client" class="contents__link">Appliquer réduction sur la première commande d&#39;un client</a></li><li><a href="#appliquer-un-prix-barré-sur-les-clients-loggés-uniquement" class="contents__link">Appliquer un prix barré sur les clients loggés uniquement</a></li><li><a href="#appliquer-pourcentage-de-remise-croissant-en-fonction-du-montant-total-du-panier" class="contents__link">Appliquer pourcentage de remise croissant en fonction du montant total du panier</a></li><li><a href="#appliquer-une-réduction-par-palier" class="contents__link">Appliquer une réduction par palier</a></li><li><a href="#réduction-par-palier-pour-un-type-de-produit" class="contents__link">Réduction par palier pour un type de produit</a></li><li><a href="#pourcentage-de-réduction-sur-le-produit-le-moins-cher-du-panier" class="contents__link">Pourcentage de réduction sur le produit le moins cher du panier</a></li><li><a href="#réduction-si-le-client-a-accepté-le-marketing-lors-de-sa-commande-précédente" class="contents__link">Réduction si le client a accepté le marketing lors de sa commande précédente</a></li><li><a href="#acheter-2-produits-lun-des-2-est-offert" class="contents__link">Acheter 2 produits, l&#39;un des 2 est offert</a></li><li><a href="#acheter-le-produit-a-et-obtenir-x-de-réduction-sur-le-produit-b-si-un-code-coupon-a-été-saisi" class="contents__link">Acheter le produit A et obtenir x% de réduction sur le produit B si un code coupon a été saisi</a></li></ul></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Docs</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://abecms.slack.com">Slack</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Website</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://livingcolor.fr">Website</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1Wg7"><img class="footer__logo" alt="Facebook Open Source Logo" src="https://docusaurus.io/img/oss_logo.png"></a></div>Copyright © 2020 Abe SAS. Built with Docusaurus.</div></div></footer>
</div>

<script src="/styles.bd11cfba.js"></script>

<script src="/runtime~main.84a8950c.js"></script>

<script src="/main.c4978552.js"></script>

<script src="/1.8786922e.js"></script>

<script src="/2.057fe307.js"></script>

<script src="/28.3dbf4cd4.js"></script>

<script src="/20ac7829.abcd58b8.js"></script>

<script src="/17896441.8afd8470.js"></script>

<script src="/55684925.5485a85f.js"></script>


</body>
</html>